<div class="row mt-4 justify-content-center text-center">
  <div class="col-12 col-md-10 col-lg-8">
    <app-info-section
      title="Account History"
      bodyMsg="This page shows the balance history of each of your accounts over time.
               Use the grids to review detailed changes and the graphs to visualize trends, growth, and fluctuations.
               Balance records are automatically added every few hours.">
    </app-info-section>
  </div>
</div>

<div class="container mt-4" *ngIf="(personalRecords$ | async)?.length === 0">
  <div class="text-center no-accounts">
    <h3 class="mb-3">No Accounts Connected Yet</h3>
    <p class="text-muted mb-4">
      Add your checking, savings, or retirement accounts to start tracking your net worth and financial progress.
    </p>
    <button class="btn btn-primary btn-lg" (click)="navToAddAcount()">
      Add Your First Account
    </button>
  </div>
</div>

<div class="container mt-4">
    @for (rec of personalRecords$ | async; track rec) {
    <details #d open (toggle)="onToggle()" class="account-details">
      <summary class="summary-header" style="cursor: pointer;">
        <div class="d-flex align-items-center justify-content-between py-2">
          <div class="d-flex align-items-center gap-2">
            <button class="collapse-icon btn btn-ghost p-0 me-2" aria-hidden="true">
              <i *ngIf="d.open" class="fa-solid fa-angle-down"></i>
              <i *ngIf="!d.open" class="fa-solid fa-chevron-right"></i>
            </button>
            <div>
              <h4 class="mb-0">{{ rec.Name }}</h4>
            </div>
          </div>
          <div class="balance-summary text-end">
            <div class="small text-muted">Current Balance</div>
            <div class="balance-badge">{{ formatCurrency(rec.Balance) }}</div>
          </div>
        </div>
      </summary>

      <div class="row mt-3 flex-column flex-lg-row account-content align-items-start">
        <div class="col-12 col-lg-4 mb-3 mb-lg-0">
          <div class="card table-card p-0 h-100">
            <div class="card-body p-0">
              <div class="table-responsive" style="max-height: 30rem;">
                <table class="table table-sm table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Date</th>
                      <th>Time</th>
                      <th>Balance</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let record of rec.Records">
                      <td>{{ record.RecordedDate | date:'MM/dd/yyyy' }}</td>
                      <td>{{ record.RecordedDate | date:'h:mm a' }}</td>
                      <td>{{ formatCurrency(record.Balance) }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-8">
          <div class="card chart-card p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="text-muted small">Balance Over Time</div>
              <div class="text-muted small">Updated periodically</div>
            </div>
            <div class="chart-wrapper">
              <canvas *ngIf="rec.ChartRecords" 
                      baseChart 
                      [data]="rec.ChartRecords" 
                      [options]="accountHistoryChartOptions" 
                      type="line">
              </canvas>
            </div>
          </div>
        </div>
      </div>
    </details>
    }
</div>
